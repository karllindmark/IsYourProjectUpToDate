<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Is your project up to date?</title>
        <link rel="stylesheet" src="//normalize-css.googlecode.com/svn/trunk/normalize.css">
        <link href='//fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="http://fgnass.github.io/spin.js/spin.min.js"></script>
        <style>
            body {
                font-family: "Roboto", sans-serif;
                font-weight: 300;
                font-size: 13px;
            }

            h1, h2, h3, h4, h5 {
                font-family: "Roboto", sans-serif;
                font-weight: 300;
                text-transform: uppercase;
            }

            h1 {
                font-size: 3em;
            }

            h2 {
                font-size: 2.8em;
            }

            h3 {
                font-size: 2.6em;
            }

            h4 {
                font-size: 2.4em;
            }

            h5 {
                font-size: 2.2em;
            }

            #wrapper {
                width: 960px;
                margin: 0 auto;
                margin-top: 100px;
                text-align: center;
            }

            .clearfix {
                clear: both;
            }

            #search-box {
                width: auto;
                height: 24px;

                display: inline-block;
                margin-top: 2.6em;
            }

            input[type="text"] {
                width: 500px;
                height: 24px;
                padding: 8px;
                font-size: 16px;
                border-radius: 2px 0 0 2px;
                border: 1px solid #CCC;
                box-shadow: 0 0 0 #FF4444;
            }

            form:hover input[type="text"], input[type="text"]:focus {
                box-shadow: 0 0 4px #FF4444;
                border: 1px solid #FF4444;
                outline: none;
            }

            .attached-button-wrap {
                width: 64px;
                height: 42px;

                display: inline-block;
                line-height: 42px;
                margin-left: -5px;

                border-radius: 0 2px 2px 0;
                box-sizing: border-box;
                border: 1px solid #CCC;

                background: #CCC;
                background-image: url('http://labs.ninetwozero.com/wordpress/wp-content/themes/ninetwozero.com_201406/images/ic_action_github.png');
                background-position: center;
                background-repeat: no-repeat;
                background-size: 36px;
            }

            .attached-button-wrap:hover {
                cursor: pointer;

            }

            form:hover .attached-button-wrap, input:focus ~ .attached-button-wrap {
                box-shadow: 1px 0 4px #FF4444;
                background-color: #FF4444;
                border: 1px solid #EE0000;
            }

            .attached-button {
                border: 0;
                background: none;
                z-index: -1;
            }

            /* Step #2 */
            #step-2 {
                display: none;
            }

            .subtle-table {
                width: 600px;
                margin-left: auto;
                margin-right: auto;
                margin-bottom: 2em;
                border-spacing: 0;
            }

            .subtle-table tr {
                border-bottom: 1px solid #EEE;
            }

            .left-col {
                width: 500px;
                text-align: left;
            }

            .right-col {
                width: 100px;
            }

            .subtle-table td {
                padding: 8px;
                border-bottom: 1px solid #EEE;
            }

            .subtle-table tr:hover td {
                background: rgba(0, 0, 0, 0.05);
            }

            .red-button {
                min-width: 96px;
                height: 42px;

                color: #FFF;
                padding: 8px;

                border-radius: 2px;
                box-sizing: border-box;
                border: 1px solid #CCC;
                background: #BBB;
                text-decoration: none;
            }

            .red-button:hover {
                box-shadow: 0 0 4px #FF4444;
                background-color: #FF4444;
                border: 1px solid #EE0000;
                cursor: pointer;
            }

            #project-deps-table .dependency-meta {
                color: #CCC;
                font-size: 0.9em;
                display: block;
            }

            /* Step 3 */
            #step-3 {
                display: none;
            }

            #export-controllers a {
                margin-left: 4px;
                margin-right: 4px;
            }
        </style>
        <script>
            $(document).ready(
                function() {
                    $('.attached-button-wrap').click(
                        function() {
                            $(this).children('.attached-button')[0].click();
                        }
                    );

                    $('#search-box').submit(
                        function(event) {
                            event.preventDefault();

                            var form = $(this);
                            var github_info = form.find("input[name='github-info']");
                            var csrf_token = form.find("input[name='csrfmiddlewaretoken']");

                            if (github_info.length == 0 || csrf_token.length == 0) {
                                alert("Notify about empty value");
                                return;
                            }

                            $.ajax(
                                {
                                    type: "POST",
                                    dataType: 'json',
                                    url:'/api/find-gradle-files/',
                                    data: form.serialize(),
                                    success: function (data) {
                                        var container = $('#project-files-table');

                                        $(data).each(
                                            function(index, item) {
                                                var new_element = $(
                                                    '<tr>' +
                                                    '    <td class="left-col">' +
                                                    '        <a href="' + item['html_url'] + '" target="_blank">' + item['path'] + '</a>' +
                                                    '    </td>' +
                                                    '    <td class="right-col">' +
                                                    '        <input name="selected" type="checkbox" checked value="' + item['html_url'] + '">' +
                                                    '    </td>' +
                                                    '</tr>'
                                                );
                                                container.append(new_element)
                                            }
                                        );

                                        // Last but not least
                                        $('#step-1').fadeOut(
                                            400, function() {
                                                $("#step-2").fadeIn(400);
                                            }
                                        );
                                    },
                                    error: function (data) {
                                        console.log("[ERROR] data => " + data);
                                    }
                                }
                            );
                        }
                    );

                    $('#project-files-box').submit(
                        function() {
                            event.preventDefault();

                            var form = $(this);
                            var file_paths = form.find("input[type='hidden']");
                            var selected_files = form.find("input[type='checkbox']");
                            var csrf_token = form.find("input[name='csrfmiddlewaretoken']");

                            if (file_paths.length == 0 || selected_files.length == 0 || csrf_token.length == 0) {
                                alert("Notify about empty value");
                                return;
                            }

                            $.ajax(
                                {
                                    type: "POST",
                                    dataType: 'json',
                                    url:'/api/find-dependencies/',
                                    data: form.serialize(),
                                    success: function (data) {
                                        console.log(data);

                                        var container = $('#project-deps-table');
                                        container.children().remove();

                                        $(data).each(
                                            function(index, item) {
                                                var new_element = $(
                                                    '<tr -data-group="' + item['g']+ '" -data-artifact="' + item['a'] + '" -data-version="' + item['v'] + '">' +
                                                    "    {% csrf_token %}" +
                                                    '    <td class="left-col">' +
                                                    '        <span>' + item['a'] + '</span>' +
                                                    '        <span class="dependency-meta">' + item['g'] +'</span>' +
                                                    '        <span class="dependency-meta">' + item['v'] + '</span>' +
                                                    '    </td>' +
                                                    '    <td class="right-col" id="progress-' + item['a'] + '">Checking...</td>' +
                                                    '</tr>'
                                                );
                                                container.append(new_element)
                                            }
                                        );
                                        // Last but not least
                                        $('#step-2').fadeOut(
                                            400, function() {
                                                $("#step-3").fadeIn(400, function() {
                                                    $('#project-deps-table').find('tr').each(
                                                        function() {
                                                            var this_elem = $(this);
                                                            var group = this_elem.attr('-data-group');
                                                            var artifact = this_elem.attr('-data-artifact');
                                                            var version = this_elem.attr('-data-version');
                                                            var csrf_token = this_elem.find("input[name='csrfmiddlewaretoken']");
                                                            var status_elem = this_elem.find('#progress-' + artifact);

                                                            var postdata = {
                                                                'group': group,
                                                                'artifact': artifact,
                                                                'version' : version,
                                                                'csrfmiddlewaretoken': csrf_token.val()
                                                            };

                                                            setTimeout(
                                                                function() {
                                                                    $.ajax(
                                                                            {
                                                                                type: "POST",
                                                                                dataType: 'json',
                                                                                url: '/api/check-for-updates/',
                                                                                data: postdata,
                                                                                success: function (data) {
                                                                                    status_elem.text(data['message']);
                                                                                },
                                                                                error: function (data) {
                                                                                    console.log("ERROR in check-for-updates call");
                                                                                    console.log(data);
                                                                                }
                                                                            }
                                                                    );
                                                                }, 500
                                                            );

                                                        }
                                                    );
                                                });
                                            }
                                        );
                                    },
                                    error: function (data) {
                                        console.log("[ERROR] data => " + data);
                                    }
                                }
                            );
                        }
                    );
                }
            )
        </script>
    </head>
    <body>
        <div id="wrapper">
            <section id="step-1">
                <h1>Is your project up to date?</h1>
                <p>As time flies, the libraries we all love to use get updated. Use this service to see if there are newer any versions for you to use in your projects.</p>
                <form method="post" id="search-box">
                    {% csrf_token %}
                    <input tabindex="0" name="github-info" placeholder="Ex: karllindmark/FizzBuzz" value="karllindmark/FizzBuzz" type="text">
                    <div class="attached-button-wrap">
                        <button tabindex="-1" class="attached-button"></button>
                    </div>
                    <div class="clearfix"></div>
                </form>
            </section>
            <section id="step-2">
                <h1>Project found!</h1>
                <p>Not only did we find your project, but we've also managed to find the following files in it. You may select/deselect any files below.</p>
                <form method="post" id="project-files-box">
                    {% csrf_token %}
                    <table id="project-files-table" class="subtle-table"></table>
                    <input class="red-button" type="submit" value="Next">
                </form>
            </section>
            <section id="step-3">
                <h1>Dependencies gathered!</h1>
                <p>Hooray! We've managed to gather the dependencies for your project. Please report any bugs you may encounter (for example, missing items)!</p>
                <table id="project-deps-table" class="subtle-table"></table>
                <div id="export-controllers">
                    <a href="#export-to-github" class="red-button">Export to Github</a>
                    <a href="#export-to-pivotal" class="red-button">Export to Pivotal Tracker</a>
                    <a href="#export-to-email" class="red-button">Export to email</a>
                </div>
            </section>
        </div>
    </body>
</html>